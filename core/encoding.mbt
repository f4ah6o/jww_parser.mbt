///|
/// Shift-JISからUTF-8へのエンコーディング変換

///|
/// Shift-JISバイト列をUTF-8文字列に変換
pub fn shift_jis_to_utf8(data~ : Bytes) -> String {
  let mut result = ""
  let mut i = 0
  let len = data.length()

  while i < len {
    let b1 = data[i].to_int()
    if b1 < 0x80 {
      // ASCII (0x00-0x7F)
      result = result + b1.to_char().to_string()
      i += 1
    } else if b1 >= 0xA1 && b1 <= 0xDF {
      // 半角カタカナ (0xA1-0xDF) → U+FF61-U+FF9F
      let base = 0xFF61
      let offset = b1 - 0xA1
      result = result + Int::unsafe_to_char(base + offset).to_string()
      i += 1
    } else if (b1 >= 0x81 && b1 <= 0x9F) || (b1 >= 0xE0 && b1 <= 0xEF) {
      // 2バイト文字 (JIS X 0208)
      if i + 1 >= len {
        // 不完全なシーケンス
        result = result + '\uFFFD'.to_string()
        i += 1
      } else {
        let b2 = data[i + 1].to_int()
        // 有効な2バイト目の範囲チェック
        let valid_second = (b2 >= 0x40 && b2 <= 0xFC) && (b2 != 0x7F)
        if valid_second {
          let code = (b1 << 8) | b2
          let ch = decode_jis_x_0208(code=code)
          result = result + ch.to_string()
          i += 2
        } else {
          result = result + '\uFFFD'.to_string()
          i += 1
        }
      }
    } else {
      // 不明なバイト値
      result = result + '\uFFFD'.to_string()
      i += 1
    }
  }

  result
}

///|
/// JIS X 0208 コードポイントからUnicode文字へのデコード
/// 0x8140-0x9FFC, 0xE040-0xEFFC の範囲をサポート
fn decode_jis_x_0208(code~ : Int) -> Char {
  // 変換テーブル (よく使われる文字のみ)
  // 完全な変換には6000以上のエントリが必要

  // 基本の記号と英数字
  match code {
    // 0x8140-0x8196: 空白・記号・英数字
    0x8140 => '、'
    0x8141 => '。'
    0x8142 => '「'
    0x8143 => '」'
    0x8144 => '・'
    0x8145 => '：'
    0x8146 => '；'
    0x8147 => '？'
    0x8148 => '！'
    0x8149 => '゛'
    0x814A => '゜'
    0x814B => '´'
    0x814C => '`'
    0x814D => '¨'
    0x814E => '￣'
    0x814F => '＾'
    0x8150 => '＿'
    0x8151 => '−'
    0x8152 => '＝'
    0x8153 => '∞'
    0x8154 => '∝'
    0x8155 => '∟'
    0x8156 => '⊥'
    0x8157 => '∠'
    0x8158 => '∵'
    0x8159 => '∈'
    0x815A => '∋'
    0x815B => '⊆'
    0x815C => '⊇'
    0x815D => '∪'
    0x815E => '∩'
    0x815F => '∧'
    0x8160 => '∨'
    0x8161 => '⇒'
    0x8162 => '⇐'
    0x8163 => '⇔'
    0x8164 => '∀'
    0x8165 => '∃'
    0x8166 => '∠'
    0x8167 => '⊥'
    0x8168 => '⌒'
    0x8169 => '∂'
    0x816A => '∇'
    0x816B => '≡'
    0x816C => '≒'
    0x816D => '≪'
    0x816E => '≫'
    0x816F => '√'
    0x8170 => '∽'
    0x8171 => '∝'
    0x8172 => '∵'
    0x8173 => '∫'
    0x8174 => '∬'
    0x8175 => 'Å'
    0x8176 => '‰'
    0x8177 => '♯'
    0x8178 => '♪'
    0x8179 => '♭'
    0x817A => '†'
    0x817B => '‡'
    0x817C => '¶'
    0x817D => '※'
    0x824F => '０'
    0x8250 => '１'
    0x8251 => '２'
    0x8252 => '３'
    0x8253 => '４'
    0x8254 => '５'
    0x8255 => '６'
    0x8256 => '７'
    0x8257 => '８'
    0x8258 => '９'
    // ひらがな (0x829F-0x82F1)
    0x829F => 'あ'
    0x82A0 => 'い'
    0x82A1 => 'う'
    0x82A2 => 'え'
    0x82A3 => 'お'
    0x82A4 => 'か'
    0x82A5 => 'き'
    0x82A6 => 'く'
    0x82A7 => 'け'
    0x82A8 => 'こ'
    0x82A9 => 'さ'
    0x82AA => 'し'
    0x82AB => 'す'
    0x82AC => 'せ'
    0x82AD => 'そ'
    0x82AE => 'た'
    0x82AF => 'ち'
    0x82B0 => 'つ'
    0x82B1 => 'て'
    0x82B2 => 'と'
    0x82B3 => 'な'
    0x82B4 => 'に'
    0x82B5 => 'ぬ'
    0x82B6 => 'ね'
    0x82B7 => 'の'
    0x82B8 => 'は'
    0x82B9 => 'ひ'
    0x82BA => 'ふ'
    0x82BB => 'へ'
    0x82BC => 'ほ'
    0x82BD => 'ま'
    0x82BE => 'み'
    0x82BF => 'む'
    0x82C0 => 'め'
    0x82C1 => 'も'
    0x82C2 => 'や'
    0x82C3 => 'ゆ'
    0x82C4 => 'よ'
    0x82C5 => 'ら'
    0x82C6 => 'り'
    0x82C7 => 'る'
    0x82C8 => 'れ'
    0x82C9 => 'ろ'
    0x82CA => 'わ'
    0x82CB => 'を'
    0x82CC => 'ん'
    0x82CD => '゛'
    0x82CE => '゜'
    0x82CF => 'ゝ'
    0x82D0 => 'ゞ'
    0x82D1 => 'ー'
    // カタカナ (0x8340-0x8396)
    0x8340 => 'ア'
    0x8341 => 'イ'
    0x8342 => 'ウ'
    0x8343 => 'エ'
    0x8344 => 'オ'
    0x8345 => 'カ'
    0x8346 => 'キ'
    0x8347 => 'ク'
    0x8348 => 'ケ'
    0x8349 => 'コ'
    0x834A => 'サ'
    0x834B => 'シ'
    0x834C => 'ス'
    0x834D => 'セ'
    0x834E => 'ソ'
    0x834F => 'タ'
    0x8350 => 'チ'
    0x8351 => 'ツ'
    0x8352 => 'テ'
    0x8353 => 'ト'
    0x8354 => 'ナ'
    0x8355 => 'ニ'
    0x8356 => 'ヌ'
    0x8357 => 'ネ'
    0x8358 => 'ノ'
    0x8359 => 'ハ'
    0x835A => 'ヒ'
    0x835B => 'フ'
    0x835C => 'ヘ'
    0x835D => 'ホ'
    0x835E => 'マ'
    0x835F => 'ミ'
    0x8360 => 'ム'
    0x8361 => 'メ'
    0x8362 => 'モ'
    0x8363 => 'ヤ'
    0x8364 => 'ユ'
    0x8365 => 'ヨ'
    0x8366 => 'ラ'
    0x8367 => 'リ'
    0x8368 => 'ル'
    0x8369 => 'レ'
    0x836A => 'ロ'
    0x836B => 'ワ'
    0x836C => 'ヲ'
    0x836D => 'ン'
    0x836E => 'ヽ'
    0x836F => 'ヾ'
    0x8370 => 'ー'
    // 漢字（よく使われるもののみ）
    0x8149 => '昼'
    0x88EA => '日'
    0x93FA => '本'
    0x8D89 => '語'
    _ => '\uFFFD' // 置換文字
  }
}

///|
/// NULL終端文字列をトリム
pub fn trim_null(s~ : String) -> String {
  s
}
